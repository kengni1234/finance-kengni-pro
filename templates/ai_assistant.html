{% extends "base.html" %}
{% block title %}Assistant IA â€” Kengni Finance{% endblock %}
{% block page_title %}Assistant IA Conversationnel{% endblock %}
{% block content %}
<style>
:root{--neon:#00d4aa;--neon2:#00ff88;--card-bg:rgba(22,22,46,.88);}
.ai-wrap{display:grid;grid-template-columns:270px 1fr;gap:1.5rem;max-width:1200px;margin:0 auto;padding:0 1rem;height:calc(100vh - 160px);}
@media(max-width:860px){.ai-wrap{grid-template-columns:1fr;height:auto;}.ai-sidebar{display:none;}}
.ai-sidebar{background:var(--card-bg);border:1px solid rgba(255,255,255,.07);border-radius:20px;padding:1.25rem;display:flex;flex-direction:column;gap:1rem;overflow-y:auto;backdrop-filter:blur(20px);}
.ai-sidebar h6{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:#a8b2d1;margin:0;padding-bottom:.5rem;border-bottom:1px solid rgba(255,255,255,.07);}
.quick-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:#c8d0e0;border-radius:10px;padding:.55rem .85rem;font-size:.8rem;cursor:pointer;text-align:left;transition:all .25s;width:100%;line-height:1.4;}
.quick-btn:hover{background:rgba(0,212,170,.1);border-color:var(--neon);color:var(--neon);transform:translateX(4px);}
.chat-panel{background:var(--card-bg);border:1px solid rgba(255,255,255,.07);border-radius:20px;display:flex;flex-direction:column;overflow:hidden;backdrop-filter:blur(20px);}
.chat-header{padding:1.2rem 1.5rem;background:linear-gradient(135deg,rgba(0,212,170,.09),rgba(102,126,234,.07));border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:1rem;}
.ai-avatar{width:42px;height:42px;background:linear-gradient(135deg,var(--neon),#667eea);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;animation:aiPulse 2s ease-in-out infinite;}
@keyframes aiPulse{0%,100%{box-shadow:0 0 0 0 rgba(0,212,170,.4)}50%{box-shadow:0 0 0 10px rgba(0,212,170,0)}}
.ai-info h5{margin:0;font-size:1rem;font-weight:800;}
.ai-info small{color:#a8b2d1;font-size:.78rem;}
.online-dot{width:8px;height:8px;background:#00ff88;border-radius:50%;display:inline-block;margin-right:4px;box-shadow:0 0 6px #00ff88;}
.chat-messages{flex:1;overflow-y:auto;padding:1.5rem;display:flex;flex-direction:column;gap:1rem;scroll-behavior:smooth;}
.chat-messages::-webkit-scrollbar{width:4px;}.chat-messages::-webkit-scrollbar-track{background:rgba(255,255,255,.03);}.chat-messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:4px;}
.msg-wrap{display:flex;gap:.75rem;animation:msgIn .3s ease;}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.msg-wrap.user{flex-direction:row-reverse;}
.msg-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.msg-avatar.ai{background:linear-gradient(135deg,var(--neon),#667eea);}
.msg-avatar.user{background:linear-gradient(135deg,#667eea,#764ba2);}
.msg-bubble{max-width:76%;padding:.85rem 1.1rem;border-radius:16px;font-size:.88rem;line-height:1.65;}
.msg-bubble.ai{background:rgba(0,212,170,.08);border:1px solid rgba(0,212,170,.15);border-bottom-left-radius:4px;color:#e0e6f8;}
.msg-bubble.user{background:linear-gradient(135deg,rgba(102,126,234,.18),rgba(118,75,162,.14));border:1px solid rgba(102,126,234,.2);border-bottom-right-radius:4px;color:#e0e6f8;text-align:right;}
.msg-time{font-size:.68rem;color:#a8b2d1;margin-top:.35rem;opacity:.7;}
.typing-dots span{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--neon);margin:0 2px;animation:dotBounce .9s infinite;}
.typing-dots span:nth-child(2){animation-delay:.15s;}.typing-dots span:nth-child(3){animation-delay:.3s;}
@keyframes dotBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}
.chat-input-bar{padding:1rem 1.2rem;border-top:1px solid rgba(255,255,255,.07);display:flex;gap:.75rem;align-items:flex-end;}
.chat-textarea{flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:#e0e6f8;border-radius:14px;padding:.75rem 1rem;font-size:.9rem;resize:none;outline:none;font-family:inherit;transition:border-color .25s,box-shadow .25s;min-height:46px;max-height:140px;overflow-y:auto;line-height:1.5;}
.chat-textarea:focus{border-color:var(--neon);box-shadow:0 0 0 3px rgba(0,212,170,.12);}
.chat-textarea::placeholder{color:#5a6380;}
.btn-send{background:linear-gradient(135deg,var(--neon),var(--neon2));border:none;color:#0f1419;border-radius:12px;width:46px;height:46px;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .25s;}
.btn-send:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,212,170,.35);}
.btn-send:active{transform:scale(.96);}
.btn-send:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none;}
.btn-clear{background:rgba(255,71,87,.1);border:1px solid rgba(255,71,87,.2);color:#ff4757;border-radius:10px;padding:.5rem .75rem;font-size:.78rem;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-clear:hover{background:rgba(255,71,87,.2);}
.welcome-card{background:linear-gradient(135deg,rgba(0,212,170,.06),rgba(102,126,234,.05));border:1px solid rgba(0,212,170,.12);border-radius:16px;padding:1.5rem;margin-bottom:.5rem;}
.welcome-card h4{font-size:1.1rem;font-weight:800;margin-bottom:.5rem;}
.welcome-card p{font-size:.85rem;color:#a8b2d1;margin-bottom:1rem;}
.example-chips{display:flex;gap:.5rem;flex-wrap:wrap;}
.example-chip{background:rgba(0,212,170,.08);border:1px solid rgba(0,212,170,.2);color:var(--neon);border-radius:50px;padding:.3rem .85rem;font-size:.78rem;cursor:pointer;transition:all .2s;}
.example-chip:hover{background:rgba(0,212,170,.18);transform:translateY(-2px);}
</style>

<div class="ai-wrap">
  <div class="ai-sidebar">
    <div>
      <h6>âš¡ Questions rapides</h6>
      <div style="display:flex;flex-direction:column;gap:.4rem;margin-top:.6rem;">
        <button class="quick-btn" onclick="sendQuick('Pourquoi j\'ai perdu ce mois-ci ?')">ğŸ“‰ Pourquoi j'ai perdu?</button>
        <button class="quick-btn" onclick="sendQuick('Quelle est ma meilleure stratÃ©gie ?')">ğŸ¯ Meilleure stratÃ©gie</button>
        <button class="quick-btn" onclick="sendQuick('Quel est mon score de trader ?')">ğŸ† Mon score trader</button>
        <button class="quick-btn" onclick="sendQuick('Quels sont mes problÃ¨mes psychologiques ?')">ğŸ§  ProblÃ¨mes psycho</button>
        <button class="quick-btn" onclick="sendQuick('Combien j\'ai gagnÃ© ou perdu en tout ?')">ğŸ’° Gains / Pertes totaux</button>
        <button class="quick-btn" onclick="sendQuick('Donne-moi des conseils pour amÃ©liorer mon trading')">ğŸ’¡ Conseils personnalisÃ©s</button>
        <button class="quick-btn" onclick="sendQuick('Montre mon solde financier')">ğŸ“Š Solde financier</button>
        <button class="quick-btn" onclick="sendQuick('Quels sont mes objectifs recommandÃ©s ?')">ğŸ¯ Mes objectifs</button>
        <button class="quick-btn" onclick="sendQuick('Combien de formations j\'ai fait ?')">ğŸ“ Mes formations</button>
      </div>
    </div>
    <div>
      <h6>â„¹ï¸ Astuce</h6>
      <div style="font-size:.78rem;color:#a8b2d1;line-height:1.6;">
        Posez vos questions en franÃ§ais naturel. L'IA analyse vos donnÃ©es en temps rÃ©el.<br><br>
        <strong style="color:var(--neon);">Exemples de formulations:</strong><br>
        â€¢ "Suis-je profitable ce mois?"<br>
        â€¢ "Analyse mes derniers trades"<br>
        â€¢ "Quand j'ai le plus de pertes?"
      </div>
    </div>
    <div>
      <h6>ğŸ”— Navigation rapide</h6>
      <div style="display:flex;flex-direction:column;gap:.35rem;margin-top:.4rem;">
        <a href="/trading" style="color:#a8b2d1;font-size:.8rem;text-decoration:none;padding:.4rem .6rem;border-radius:8px;background:rgba(255,255,255,.03);">ğŸ“ˆ Trading</a>
        <a href="/journal" style="color:#a8b2d1;font-size:.8rem;text-decoration:none;padding:.4rem .6rem;border-radius:8px;background:rgba(255,255,255,.03);">ğŸ““ Journal</a>
        <a href="/finances" style="color:#a8b2d1;font-size:.8rem;text-decoration:none;padding:.4rem .6rem;border-radius:8px;background:rgba(255,255,255,.03);">ğŸ’° Finances</a>
        <a href="/analysis" style="color:#a8b2d1;font-size:.8rem;text-decoration:none;padding:.4rem .6rem;border-radius:8px;background:rgba(255,255,255,.03);">ğŸ”¬ Analyse</a>
        <a href="/training" style="color:#a8b2d1;font-size:.8rem;text-decoration:none;padding:.4rem .6rem;border-radius:8px;background:rgba(255,255,255,.03);">ğŸ“ Formations</a>
      </div>
    </div>
  </div>

  <div class="chat-panel">
    <div class="chat-header">
      <div class="ai-avatar">ğŸ¤–</div>
      <div class="ai-info">
        <h5><span class="online-dot"></span>Assistant IA Kengni Finance</h5>
        <small>Trading Â· Finances Â· Psychologie Â· Formation</small>
      </div>
      <button class="btn-clear ms-auto" onclick="clearChat()">ğŸ—‘ Effacer</button>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="msg-wrap">
        <div class="msg-avatar ai">ğŸ¤–</div>
        <div>
          <div class="msg-bubble ai">
            <div class="welcome-card">
              <h4>ğŸ‘‹ Bonjour! Je suis votre assistant IA</h4>
              <p>J'analyse vos donnÃ©es de trading, finances et formations pour vous donner des insights personnalisÃ©s. Cliquez sur un exemple ou posez votre question :</p>
              <div class="example-chips">
                <span class="example-chip" onclick="sendQuick('Pourquoi j\'ai perdu ce mois ?')">ğŸ“‰ Pertes du mois</span>
                <span class="example-chip" onclick="sendQuick('Mon score trader ?')">ğŸ† Mon score</span>
                <span class="example-chip" onclick="sendQuick('Conseils pour m\'amÃ©liorer')">ğŸ’¡ Conseils</span>
                <span class="example-chip" onclick="sendQuick('Mon solde financier')">ğŸ’° Finances</span>
              </div>
            </div>
          </div>
          <div class="msg-time">Maintenant</div>
        </div>
      </div>
    </div>

    <div class="chat-input-bar">
      <textarea id="userInput" class="chat-textarea"
        placeholder="Posez votre question... (EntrÃ©e = envoyer, Maj+EntrÃ©e = nouvelle ligne)"
        rows="1" oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
      <button class="btn-send" id="sendBtn" onclick="sendMessage()" title="Envoyer">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

<script>
const chatMessages = document.getElementById('chatMessages');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');

function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,140)+'px'; }
function handleKey(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }

function nowStr(){
  const d=new Date();
  return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');
}

function appendMsg(text, role){
  const wrap=document.createElement('div');
  wrap.className=`msg-wrap ${role}`;
  const avatar=role==='ai'?'ğŸ¤–':'ğŸ‘¤';
  const formatted=String(text)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\n/g,'<br>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  wrap.innerHTML=`
    <div class="msg-avatar ${role}">${avatar}</div>
    <div>
      <div class="msg-bubble ${role}">${formatted}</div>
      <div class="msg-time">${nowStr()}</div>
    </div>`;
  chatMessages.appendChild(wrap);
  chatMessages.scrollTop=chatMessages.scrollHeight;
  return wrap;
}

function appendTyping(){
  const wrap=document.createElement('div');
  wrap.className='msg-wrap';
  wrap.id='typingIndicator';
  wrap.innerHTML=`
    <div class="msg-avatar ai">ğŸ¤–</div>
    <div><div class="msg-bubble ai" style="padding:.7rem 1.1rem;">
      <div class="typing-dots"><span></span><span></span><span></span></div>
    </div></div>`;
  chatMessages.appendChild(wrap);
  chatMessages.scrollTop=chatMessages.scrollHeight;
  return wrap;
}

async function sendMessage(){
  const question=userInput.value.trim();
  if(!question) return;
  appendMsg(question,'user');
  userInput.value=''; userInput.style.height='auto';
  sendBtn.disabled=true;
  const typing=appendTyping();
  try{
    const resp=await fetch('/api/ai-chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({question})
    });
    const data=await resp.json();
    typing.remove();
    appendMsg(data.answer||'Pas de rÃ©ponse.','ai');
  }catch(err){
    typing.remove();
    appendMsg('âŒ Erreur de connexion au service IA. VÃ©rifiez que le serveur est actif.','ai');
  }finally{
    sendBtn.disabled=false;
    userInput.focus();
  }
}

function sendQuick(q){
  userInput.value=q;
  sendMessage();
}

function clearChat(){
  if(!confirm('Effacer la conversation ?')) return;
  chatMessages.innerHTML='';
  appendMsg('Conversation rÃ©initialisÃ©e. Posez votre prochaine question !','ai');
}
</script>
{% endblock %}